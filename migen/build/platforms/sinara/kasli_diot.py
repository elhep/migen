from migen.build.generic_platform import *
from migen.build.xilinx import XilinxPlatform


_io_v1_0 = [
    # On-board peripherals I2C
    ("i2c", 0,
        Subsignal("scl", Pins("AP10")),
        Subsignal("sda", Pins("AP11")),
        IOStandard("LVCMOS33")
    ),

    # DIOT Peripherals I2C
    ("i2c", 1,
        Subsignal("scl", Pins("AL5")),
        Subsignal("sda", Pins("AM5")),
        IOStandard("LVCMOS33")
    ),

    # Monitoring I2C
    ("i2c", 2,
        Subsignal("scl", Pins("AM7")),
        Subsignal("sda", Pins("AL8")),
        IOStandard("LVCMOS33")
    ),

    # EEPROM I2C
    ("i2c", 3,
        Subsignal("scl", Pins("AN11")),
        Subsignal("sda", Pins("AM11")),
        IOStandard("LVCMOS33")
    ),

    ("ddram", 0,
        Subsignal("a", Pins(
            "AH1 AG5 AH3 AF3 AF8 AG2 AG6 AG4 "
            "AJ4 AG1 AD6 AJ1 AD4 AH4 AH6"),
            IOStandard("SSTL15")),
        Subsignal("ba", Pins("AE1 AE7 AH2"), IOStandard("SSTL15")),
        Subsignal("ras_n", Pins("AD3"), IOStandard("SSTL15")),
        Subsignal("cas_n", Pins("AE2"), IOStandard("SSTL15")),
        Subsignal("we_n", Pins("AF2"), IOStandard("SSTL15")),
        Subsignal("cs_n", Pins("AE3"), IOStandard("SSTL15")),
        Subsignal("dm", Pins("AB10 AC1 Y1 Y10"), IOStandard("SSTL15")),
        Subsignal("dq", Pins(
            "AC8 AA10 AC7 AA9 AC6 AA8 AC9 AB9 "
            "AC4 AB5 AC2 AA2 AB4 AA5 AC3 AA3 "
            "W4 V2 V4 V1 Y5 W1 V3 W3 "
            "Y7 W6 V6 V9 V8 W10 V7 Y8"),
            IOStandard("SSTL15"),
            Misc("IN_TERM=UNTUNED_SPLIT_50")),
        Subsignal("dqs_p", Pins("AB7 AB2 Y3 W9"), IOStandard("DIFF_SSTL15")),
        Subsignal("dqs_n", Pins("AB6 AB1 Y2 W8"), IOStandard("DIFF_SSTL15")),
        Subsignal("clk_p", Pins("AE5"), IOStandard("DIFF_SSTL15")),
        Subsignal("clk_n", Pins("AF5"), IOStandard("DIFF_SSTL15")),
        Subsignal("cke", Pins("AD5"), IOStandard("SSTL15")),
        Subsignal("odt", Pins("AD1"), IOStandard("SSTL15")),
        Subsignal("reset_n", Pins("AH7"), IOStandard("LVCMOS15")),
        Misc("SLEW=FAST"),
    ),

    ("serial", 0,
        Subsignal("rx", Pins("U9")),  # FPGA input, schematics TxD_2V5
        Subsignal("tx", Pins("T10")),  # FPGA output, schematics RxD_2V5
        IOStandard("LVCMOS25")
    ),

    ("user_led", 0, Pins("R8"), IOStandard("LVCMOS25")),
    ("user_led", 1, Pins("P8"), IOStandard("LVCMOS25")),
    ("user_led", 2, Pins("U6"), IOStandard("LVCMOS25")),
    ("error_led", 0, Pins("U1"), IOStandard("LVCMOS25")),

    ("mcx_clkin", 0,
        Subsignal("p", Pins("P4")),
        Subsignal("n", Pins("P3")),
        IOStandard("LVDS_25"), Misc("DIFF_TERM=TRUE")
    ),
    ("cdr_clk", 0,
        Subsignal("p", Pins("R10")),
        Subsignal("n", Pins("P10")),
        IOStandard("LVDS_25"),
    ),
    ("cdr_clk_clean", 0,
        Subsignal("p", Pins("AG14")),
        Subsignal("n", Pins("AH14")),
    ),
    ("cdr_clk_clean_fabric", 0,
        Subsignal("p", Pins("R6")),
        Subsignal("n", Pins("R5")),
        IOStandard("LVDS_25"),
    ),

    ("ddmtd_main_dcxo_i2c", 0,
        Subsignal("scl", Pins("R2")),
        Subsignal("sda", Pins("T7")),
        IOStandard("LVCMOS25")
    ),
    ("ddmtd_helper_dcxo_i2c", 0,
        Subsignal("scl", Pins("T8")),
        Subsignal("sda", Pins("U10")),
        IOStandard("LVCMOS25")
    ),
    ("ddmtd_helper_clk", 0,
        Subsignal("p", Pins("P5")),
        Subsignal("n", Pins("N4")),
        IOStandard("LVDS_25"), Misc("DIFF_TERM=TRUE")
    ),

    ("spiflash", 0,
        Subsignal("cs_n", Pins("P6")),
        Subsignal("dq", Pins("V28 V29 V26 V27")),
        # "clk" is on CCLK
        IOStandard("LVCMOS25")
    ),
    ("spiflash2x", 0,
        Subsignal("cs_n", Pins("P6")),
        Subsignal("dq", Pins("V28 V29")),
        Subsignal("wp", Pins("V26")),
        Subsignal("hold", Pins("V27")),
        # "clk" is on CCLK
        IOStandard("LVCMOS25")
    ),

    ("clk125_gtp", 0,
        Subsignal("p", Pins("AG16")),
        Subsignal("n", Pins("AH16")),
    ),

    ("sfp", 0,
        Subsignal("txp", Pins("AN17")),
        Subsignal("txn", Pins("AP17")),
        Subsignal("rxp", Pins("AJ17")),
        Subsignal("rxn", Pins("AK17")),
    ),

    ("sfp", 1,
        Subsignal("txp", Pins("AN15")),
        Subsignal("txn", Pins("AP15")),
        Subsignal("rxp", Pins("AL16")),
        Subsignal("rxn", Pins("AM16")),
    ),

    ("sfp", 2,
        Subsignal("txp", Pins("AL14")),
        Subsignal("txn", Pins("AM14")),
        Subsignal("rxp", Pins("AJ15")),
        Subsignal("rxn", Pins("AK15")),
    ),

    ("sfp", 3,
        Subsignal("txp", Pins("AN13")),
        Subsignal("txn", Pins("AP13")),
        Subsignal("rxp", Pins("AJ13")),
        Subsignal("rxn", Pins("AK13")),
    ),

    ("servmod", 0,
        Pins("AN1 AP1 AN2 AK1 AM2 AK2 AK3 AL2"), IOStandard("LVCMOS33")
    ),

    ("diot_pwr_cycle_req", 0, Pins("AM1"), IOStandard("LVCMOS33")),
    ("diot_rst_n", 0, Pins("AN4"), IOStandard("LVCMOS33")),
    ("diot_prst_n", 0, Pins("AP6"), IOStandard("LVCMOS33")),
    ("diot_pwrbtn_n", 0, Pins("AP8"), IOStandard("LVCMOS33")),
    ("diot_pwrfail_n", 0, Pins("AN8"), IOStandard("LVCMOS33")),

    ("diot_mon_p_io", 0, Pins("AK10 AM9 AL10"), IOStandard("LVCMOS33")),
    ("diot_mon_p_pres_n", 0, Pins("AP9 AN9"), IOStandard("LVCMOS33")),
    ("diot_mon_p_rst", 0, Pins("AK7"), IOStandard("LVCMOS33")),
    ("diot_mon_f_io", 0, Pins("AM6 AL9"), IOStandard("LVCMOS33")),
    ("diot_mon_f_rst", 0, Pins("AM10"), IOStandard("LVCMOS33")),

    ("assembly_variant", 0, Pins("M11 M10"), IOStandard("LVCMOS25")),
    ("hw_rev", 0, Pins("N2 N1 P1 R1"), IOStandard("LVCMOS25")),
    
    ("tp", 0, Pins("N9"), IOStandard("LVCMOS25")),
    ("tp", 1, Pins("N6"), IOStandard("LVCMOS25")),
    ("tp", 2, Pins("N8"), IOStandard("LVCMOS25")),
    ("tp", 3, Pins("N7"), IOStandard("LVCMOS25")),

]


_connectors_diot = [
    ("diot0", {
        "d0_cc_p": "AJ28",
        "d0_cc_n": "AK28",
        "d1_p": "AM31",
        "d1_n": "AN32",
        "d2_p": "AL34",
        "d2_n": "AM34",
        "d3_p": "AP29",
        "d3_n": "AP30",
        "d4_p": "AN34",
        "d4_n": "AP34",
        "d5_p": "AK33",
        "d5_n": "AL33",
        "d6_p": "AN33",
        "d6_n": "AP33",
        "d7_p": "AJ33",
        "d7_n": "AJ34",
        "d8_cc_p": "AL28",
        "d8_cc_n": "AL29",
        "d9_p": "AL30",
        "d9_n": "AM30",
        "d10_p": "AM29",
        "d10_n": "AN29",
        "d11_p": "AL32",
        "d11_n": "AM32",
        "d12_p": "AN28",
        "d12_n": "AP28",
        "d13_p": "AM27",
        "d13_n": "AN27",
        "d14_p": "AJ29",
        "d14_n": "AK30",
        "d15_p": "AJ31",
        "d15_n": "AK32",
    }),

    ("diot1", {
        "d0_cc_p": "AA30",
        "d0_cc_n": "AB30",
        "d1_p": "W33",
        "d1_n": "W34",
        "d2_p": "AA32",
        "d2_n": "AA33",
        "d3_p": "AC28",
        "d3_n": "AC29",
        "d4_p": "AB31",
        "d4_n": "AB32",
        "d5_p": "AB24",
        "d5_n": "AB25",
        "d6_p": "AB26",
        "d6_n": "AB27",
        "d7_p": "AC33",
        "d7_n": "AC34",
        "d8_cc_p": "W30",
        "d8_cc_n": "W31",
        "d9_p": "AA34",
        "d9_n": "AB34",
        "d10_p": "AA27",
        "d10_n": "AA28",
        "d11_p": "AA24",
        "d11_n": "AA25",
        "d12_p": "AA29",
        "d12_n": "AB29",
        "d13_p": "Y32",
        "d13_n": "Y33",
        "d14_p": "Y30",
        "d14_n": "Y31",
        "d15_p": "AC31",
        "d15_n": "AC32",
    }),

    ("diot2", {
        "d0_cc_p": "AG29",
        "d0_cc_n": "AG30",
        "d1_p": "AD33",
        "d1_n": "AD34",
        "d2_p": "AE33",
        "d2_n": "AF33",
        "d3_p": "AE32",
        "d3_n": "AF32",
        "d4_p": "AD31",
        "d4_n": "AE31",
        "d5_p": "AG27",
        "d5_n": "AH27",
        "d6_p": "AD26",
        "d6_n": "AE26",
        "d7_p": "AD25",
        "d7_n": "AE25",
        "d8_cc_p": "AF29",
        "d8_cc_n": "AF30",
        "d9_p": "AG24",
        "d9_n": "AH24",
        "d10_p": "AD30",
        "d10_n": "AE30",
        "d11_p": "AE27",
        "d11_n": "AF27",
        "d12_p": "AC26",
        "d12_n": "AC27",
        "d13_p": "AG32",
        "d13_n": "AH32",
        "d14_p": "AF34",
        "d14_n": "AG34",
        "d15_p": "AH33",
        "d15_n": "AH34",
    }),

    ("diot3", {
        "d0_cc_p": "P28",
        "d0_cc_n": "P29",
        "d1_p": "U31",
        "d1_n": "U32",
        "d2_p": "R25",
        "d2_n": "P25",
        "d3_p": "R31",
        "d3_n": "P31",
        "d4_p": "T33",
        "d4_n": "R33",
        "d5_p": "P33",
        "d5_n": "P34",
        "d6_p": "M30",
        "d6_n": "M31",
        "d7_p": "U26",
        "d7_n": "U27",
        "d8_cc_p": "U29",
        "d8_cc_n": "T29",
        "d9_p": "U34",
        "d9_n": "T34",
        "d10_p": "T28",
        "d10_n": "R28",
        "d11_p": "U25",
        "d11_n": "T25",
        "d12_p": "P24",
        "d12_n": "N24",
        "d13_p": "R26",
        "d13_n": "P26",
        "d14_p": "T32",
        "d14_n": "R32",
        "d15_p": "T27",
        "d15_n": "R27",
    }),

    ("diot4", {
        "d0_cc_p": "U30",
        "d0_cc_n": "T30",
        "d1_p": "N26",
        "d1_n": "M27",
        "d2_p": "R30",
        "d2_n": "P30",
        "d3_p": "N29",
        "d3_n": "M29",
        "d4_p": "N31",
        "d4_n": "M32",
        "d5_p": "N32",
        "d5_n": "N33",
        "d6_p": "N34",
        "d6_n": "M34",
        "d7_p": "N27",
        "d7_n": "N28",
        "d8_cc_p": "AH28",
        "d8_cc_n": "AH29",
        "d9_p": "AG31",
        "d9_n": "AH31",
        "d10_p": "AE28",
        "d10_n": "AF28",
        "d11_p": "AC24",
        "d11_n": "AD24",
        "d12_p": "AF25",
        "d12_n": "AG25",
        "d13_p": "AE23",
        "d13_n": "AF23",
        "d14_p": "AG26",
        "d14_n": "AH26",
        "d15_p": "AD28",
        "d15_n": "AD29",
    }),

    ("diot5", {
        "d0_cc_p": "J28",
        "d0_cc_n": "H28",
        "d1_p": "L27",
        "d1_n": "K27",
        "d2_p": "K33",
        "d2_n": "J34",
        "d3_p": "L29",
        "d3_n": "L30",
        "d4_p": "K30",
        "d4_n": "J30",
        "d5_p": "M24",
        "d5_n": "L24",
        "d6_p": "J33",
        "d6_n": "H34",
        "d7_p": "G29",
        "d7_n": "G30",
        "d8_cc_p": "J29",
        "d8_cc_n": "H29",
        "d9_p": "H27",
        "d9_n": "G27",
        "d10_p": "H32",
        "d10_n": "G32",
        "d11_p": "J24",
        "d11_n": "H24",
        "d12_p": "K26",
        "d12_n": "J26",
        "d13_p": "H33",
        "d13_n": "G34",
        "d14_p": "H31",
        "d14_n": "G31",
        "d15_p": "L33",
        "d15_n": "L34",
    }),

    ("diot6", {
        "d0_cc_p": "K7",
        "d0_cc_n": "K6",
        "d1_p": "H11",
        "d1_n": "G11",
        "d2_p": "L8",
        "d2_n": "K8",
        "d3_p": "G10",
        "d3_n": "G9",
        "d4_p": "K11",
        "d4_n": "J11",
        "d5_p": "L12",
        "d5_n": "K12",
        "d6_p": "J9",
        "d6_n": "J8",
        "d7_p": "G7",
        "d7_n": "G6",
        "d8_cc_p": "G5",
        "d8_cc_n": "G4",
        "d9_p": "K10",
        "d9_n": "J10",
        "d10_p": "H9",
        "d10_n": "H8",
        "d11_p": "H2",
        "d11_n": "G2",
        "d12_p": "H4",
        "d12_n": "H3",
        "d13_p": "K1",
        "d13_n": "J1",
        "d14_p": "F3",
        "d14_n": "F2",
        "d15_p": "L10",
        "d15_n": "L9",
    }),

    ("diot7", {
        "d0_cc_p": "L28",
        "d0_cc_n": "K28",
        "d1_p": "K25",
        "d1_n": "J25",
        "d2_p": "M25",
        "d2_n": "L25",
        "d3_p": "L32",
        "d3_n": "K32",
        "d4_p": "K31",
        "d4_n": "J31",
        "d5_p": "G24",
        "d5_n": "G25",
        "d6_p": "H26",
        "d6_n": "G26",
        "d7_p": "K23",
        "d7_n": "J23",
        "d8_cc_p": "H7",
        "d8_cc_n": "H6",
        "d9_p": "L4",
        "d9_n": "L3",
        "d10_p": "J6",
        "d10_n": "J5",
        "d11_p": "M2",
        "d11_n": "L2",
        "d12_p": "K3",
        "d12_n": "K2",
        "d13_p": "J4",
        "d13_n": "J3",
        "d14_p": "H1",
        "d14_n": "G1",
        "d15_p": "L5",
        "d15_n": "K5",
    })
]


class Platform(XilinxPlatform):
    # default_clk_name = "clk50"
    # default_clk_period = 20.0
    userid = 0xffffffff

    def __init__(self, hw_rev="v1.0"):
        if hw_rev == "v1.0":
            io_rev = _io_v1_0
        else:
            raise ValueError("Unknown hardware revision", hw_rev)
        self.hw_rev = hw_rev

        XilinxPlatform.__init__(
                self, "xc7a200t-ffg1156-3", io_rev, _connectors_diot,
                toolchain="vivado")
        self.toolchain.bitstream_commands.extend([
            "set_property BITSTREAM.CONFIG.OVERTEMPPOWERDOWN Enable [current_design]",
            "set_property BITSTREAM.GENERAL.COMPRESS True [current_design]",
            "set_property BITSTREAM.CONFIG.CONFIGRATE 16 [current_design]",
            "set_property BITSTREAM.CONFIG.SPI_BUSWIDTH 1 [current_design]",
            "set_property BITSTREAM.CONFIG.USR_ACCESS TIMESTAMP [current_design]",
            "set_property BITSTREAM.CONFIG.USERID \"{:#010x}\" [current_design]".format(self.userid),
            "set_property CFGBVS VCCO [current_design]",
            "set_property CONFIG_VOLTAGE 2.5 [current_design]",
            ])
        self.toolchain.explore_opt_design = True
